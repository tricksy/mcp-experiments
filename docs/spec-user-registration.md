# ユーザー登録機能 仕様書

## 概要

Google Apps Scriptを使用して、コンテナバインドしたスプレッドシートを管理UIの「単一ソース」として活用し、5枚の基本シート（初期設定／返答タイトル／返答条件／返答内容／ボタン設定）および複数の応用シートへのデータ登録・編集・確認を実現する機能です。

## 前提条件

- Google Spreadsheetがコンテナバインドされていること
- 以下の基本シートが存在すること：
  1. 初期設定
  2. 返答タイトル
  3. 返答条件
  4. 返答内容
  5. ボタン設定
- 応用機能のために以下のシートも存在：
  1. (応用)フラグ条件
  2. (応用)フラグ変更
  3. (応用)画像生成
  4. スクリプト
  5. (応用)画像生成部品
  6. (応用)画像生成部品(計算)
  7. (応用)返答内容(計算)
  8. config
  9. トロフィ条件
  10. トロフィ
  11. 変数
  12. マニュアル
  13. ESCAPE.iD（サマリー）
- 各シートには適切なヘッダー行が設定されていること
- 画像表示にはDropbox共有リンクを使用すること

## 機能一覧

### 1. データの表示・編集

- タブUI形式で基本シートのデータを表示・編集できる
- 各タブに対応する追加・削除・保存機能がある
- 各シートのデータは相互参照されている（例：返答内容の「返答タイトル」選択肢は、返答タイトルシートのデータに基づく）
- 種別に応じた入力フィールドの動的表示機能

### 2. データ検証

- 必須項目の入力チェック
- 重複データのチェック（章名、タイトル名、コードなど）
- デフォルト設定のチェック（デフォルト章、デフォルトLINEアカウントは1つのみ）
- 数値フィールドの値チェック

### 3. CSVインポート/エクスポート

- 各シートのデータをCSV形式でエクスポート可能
- CSVデータを各シートにインポート可能
- インポート時にはヘッダー検証とデータ検証を実施

## 使用方法

### 基本操作

1. スプレッドシート上部メニューから「管理ツール」→「データ登録・編集」を選択
2. ダイアログが表示され、タブで各シートのデータを切り替えて操作可能
3. 「保存」ボタンでスプレッドシートにデータを反映

### 種別に応じた入力フィールド

各データ種別に応じて関連する入力フィールドのみが表示されます：

- 返答内容の種別（text, image, buttons等）によって必要なフィールドのみ表示
- ボタン設定の種別（postback, message, uri等）によって必要なフィールドのみ表示
- ラベルの名称も種別に応じて変化（例：「メイン」→「タイトル」や「スタンプID」など）

### CSVインポート/エクスポート

1. 各タブの「CSVエクスポート」ボタンでデータをエクスポート（クリップボードとファイル保存）
2. 「CSVインポート」ボタンで表示されるダイアログにCSVデータを貼り付けてインポート

## データ構造

### 初期設定シート
| 列 | 見出し | 型 | 備考 |
|----|--------|----|------|
| B | No (章) | 整数 | 章レコードの連番（チェック用） |
| C | 章 | 文字列 | 章名（主キー） |
| D | デフォルト章 | チェックボックス (TRUE/FALSE) | TRUE 行は 1 行のみ許可 |
| E | (空) | Spacer | — |
| F | No (LINE) | 整数 | LINE アカウント連番 |
| G | LINEアカウント | 文字列 | 任意 ID 文字列 |
| H | デフォルトLINE | チェックボックス (TRUE/FALSE) | TRUE 行は 1 行のみ許可 |

### 返答タイトルシート
| 列 | 名称 | 型 | 備考 |
|----|------|----|------|
| B | 返答タイトル | 文字列（ユニーク） | 主キー |
| C | LINEアカウント | リスト: 初期設定!B:B |
| D | 次章 | 文字列／空欄可 | フロー終了時は空欄 |

### 返答条件シート
| 列 | 名称 | 型 | 備考 |
|----|------|----|------|
| B | 返答条件コード | 整数 | GAS で自動採番 (MAX+1) |
| C | 章 | 文字列 | 初期設定!A:A 参照 |
| D | 優先度 | 数値 | デフォルト 0 |
| E | 登録状況 | `未登録` / `有料登録` / `無料登録` |
| F | イベントタイプ | `message` / `postback` 他追加容易 |
| G | 関数名 | 文字列 | 任意 (外部連携呼び出し) |
| H | 引数(1) | 文字列 | 任意 |
| I | スクリプトコード | 文字列 | 自由記入（コード断片可） |
| J | Scriptパターン | 文字列 | 自由記入 |

### 返答内容シート
| 列 | 名称 | 型 | 備考 |
|----|------|----|------|
| B | 返答内容コード | 文字列（ユニーク） | 主キー |
| C | 返答タイトル | 文字列 | 返答タイトル!A:A 参照 |
| D | 種別 | `text` / `buttons` / `image` / `sticker` / `location` / `imagemap` / `confirm` / `image-carousel` / `richmenu` / `flex` / `escape:pay` |
| E | 送信者名 | 文字列 | 任意 |
| F | 送信者アイコン | URL | Dropbox 共有リンク可 |
| G | 画像 | URL | 任意 (種別=image などの場合) |
| H | メイン | 文字列 | 本文またはタイトル |
| I | サブ1 | 文字列 | 任意 |
| J | サブ2 | 文字列 | 任意 |
| K | 順番 | 整数 (デフォルト1) | 同一タイトル内表示順、任意変更可 |
| L | LINEアカウント | 文字列 | 初期設定!B:B 参照 |

### ボタン設定シート
| 列 | 名称 | 型 | 備考 |
|----|------|----|------|
| B | 返答内容コード | 文字列 | 返答内容!A:A 参照 |
| C | 種別 | `postback` / `message` / `image-carousel-message` / `quickreply-message` / `uri` / `area-message` |
| D | 画像 | URL | 任意、Dropbox 共有リンク |
| E | メイン1 | 文字列 | 任意 |
| F | メイン2 | 文字列 | 任意 |
| G | サブ1 | 文字列 | 任意 |
| H | サブ2 | 文字列 | 任意 |
| I | サブ3 | 文字列 | 任意 |
| J | 順番 | 整数 (デフォルト1) | 同一返答内容内並び順 |

### (応用)フラグ条件シート
| 列 | 名称 | 型 | 備考 |
|----|------|----|------|
| B | コード | 整数 | ユニーク |
| C | フラグ条件 | 文字列 | フラグ名と条件式 |
| D | 返答タイトル | 文字列 | 返答タイトル!B:B 参照 |

### (応用)フラグ変更シート
| 列 | 名称 | 型 | 備考 |
|----|------|----|------|
| B | コード | 整数 | ユニーク |
| C | 返答内容コード | 文字列 | 返答内容!B:B 参照 |
| D | フラグ名 | 文字列 | 変数シート参照 |
| E | 操作 | `set`/`add`/`del` | 設定/加算/減算 |
| F | 値 | 整数/文字列 | 設定値 |

### (応用)画像生成シート
| 列 | 名称 | 型 | 備考 |
|----|------|----|------|
| B | 画像コード | 文字列 | ユニーク |
| C | ベース画像 | URL | 背景となる画像 |
| D | 説明 | 文字列 | 説明用メモ |

### スクリプトシート
| 列 | 名称 | 型 | 備考 |
|----|------|----|------|
| B | スクリプト名 | 文字列 | ユニーク |
| C | 内容 | 文字列 | JavaScriptコード |

### 変数シート
| 列 | 名称 | 型 | 備考 |
|----|------|----|------|
| B | 変数名 | 文字列 | ユニーク |
| C | 初期値 | 整数/文字列 | 変数初期設定値 |
| D | 説明 | 文字列 | 変数の説明 |

### トロフィ条件シート
| 列 | 名称 | 型 | 備考 |
|----|------|----|------|
| B | トロフィID | 文字列 | ユニーク |
| C | 名前 | 文字列 | トロフィ名 |
| D | 条件 | 文字列 | 獲得条件式 |
| E | 画像URL | URL | トロフィ画像 |

## UIコンポーネント仕様

### タブインターフェース
- 各基本シート（初期設定／返答タイトル／返答条件／返答内容／ボタン設定）に対応するタブ
- タブ切り替えでデータ表示を即時更新
- モバイルフレンドリーなレスポンシブデザイン

### モーダルダイアログ
- 返答内容とボタン設定の詳細編集用モーダル
- 種別選択による動的フィールド表示
- 画像プレビュー機能

### ボタン・アクション
- 各タブに「追加」「保存」ボタン
- 各レコードに「編集」「削除」ボタン
- 保存時の自動バリデーション